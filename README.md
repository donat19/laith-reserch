# 3D Path Integral Raymarcher Engine

**Физически-корректный движок рендеринга на основе интегралов по путям для Apple Silicon**

## 📋 Описание проекта

Этот проект представляет собой уникальную реализацию рендеринга на основе квантово-механических принципов интегралов по путям (Path Integral Raymarching). Движок симулирует распространение света как квантовые амплитуды вероятности, что позволяет получать физически корректные интерференционные паттерны и дисперсионные эффекты.

### 🎯 Основные особенности
- **Спектральный рендеринг RGB** с реалистичными длинами волн
- **GPU ускорение** на Apple Silicon (Metal Performance Shaders)
- **Real-time интерактивность** с адаптивным качеством
- **Физически корректная** симуляция интерференции и дисперсии
- **Переключаемые режимы** (цветной/монохромный)

## � Структура проекта

### 1. `3_d_path_integral_raymarcher.py` - Базовая CPU версия
**Назначение**: Референсная реализация для демонстрации концепции
**Размер**: ~7KB | **Производительность**: Низкая (CPU only)

```python
# Основные компоненты:
├── SDF функции (сцена)
│   ├── sdf_sphere()      # Сферы
│   ├── sdf_plane()       # Плоскости
│   └── scene_sdf()       # Комбинированная сцена
├── Утилиты
│   ├── normalize()       # Нормализация векторов
│   └── orthonormal_basis() # Базис камеры
└── Рендерер
    └── render()          # Основной цикл рендеринга
```

**Характеристики**:
- Разрешение: 220x140
- SPP: 60 семплов на пиксель
- Сегменты пути: 8
- Время рендера: ~30-60 сек

### 2. `3d_path_integral_raymarcher_v2_gpu.py` - GPU версия v2.0
**Назначение**: Первая GPU реализация с базовой оптимизацией
**Размер**: ~15KB | **Производительность**: Средняя (MPS/CPU)

```python
# Архитектура:
├── GPURaymarcher (класс)
│   ├── __init__()               # Инициализация GPU
│   ├── _setup_screen_coords()   # Предвычисления
│   ├── normalize_gpu()          # GPU нормализация
│   ├── scene_sdf_gpu()          # GPU SDF
│   ├── update_camera()          # Обновление камеры
│   ├── render_frame_gpu()       # Основной рендеринг
│   └── trace_paths_vectorized() # Векторизованная трассировка
└── RealTimeRenderer (класс)
    ├── __init__()               # Pygame инициализация
    ├── handle_events()          # Обработка событий
    ├── draw_ui()               # Интерфейс
    └── run()                   # Основной цикл
```

**Характеристики**:
- Разрешение: 512x512
- SPP: 32 семпла (адаптивно)
- Real-time: ~10-15 FPS
- Монохромный рендеринг

### 3. `3d_path_integral_raymarcher_v2_1_optimized.py` - Продвинутая версия v2.1
**Назначение**: Высокооптимизированная версия со спектральным рендерингом
**Размер**: ~20KB | **Производительность**: Высокая (MPS оптимизировано)

```python
# Продвинутая архитектура:
├── OptimizedGPURaymarcher (класс)
│   ├── Спектральные параметры
│   │   ├── wavelengths_rgb{}    # RGB длины волн
│   │   ├── k_red, k_green, k_blue # Волновые числа
│   │   └── color_mode           # Переключатель режимов
│   ├── Оптимизированные методы
│   │   ├── _render_color_frame()    # RGB рендеринг
│   │   ├── _render_monochrome_frame() # Ч/Б рендеринг
│   │   ├── _render_channel()        # Отдельный канал
│   │   ├── _trace_simplified_channel() # Спектральная трассировка
│   │   └── _calculate_dispersion()  # Дисперсионные эффекты
│   ├── Адаптивное качество
│   │   ├── adaptive_quality_control() # Управление FPS
│   │   ├── target_fps = 15.0        # Целевой FPS
│   │   └── min_spp/max_spp          # Диапазон качества
│   └── Буферизация
│       ├── _init_buffers()          # RGB/Mono буферы
│       └── pixel_intensities_rgb    # Цветные буферы
└── InteractiveRenderer (класс)
    ├── Расширенное управление
    │   ├── toggle_color_mode()     # C - переключение режимов
    │   ├── quality_control()       # Q/E - качество
    │   └── adaptive_toggle()       # R - адаптивность
    ├── Терминальный интерфейс
    │   ├── Подробные инструкции
    │   ├── Статус сообщения
    │   └── Логирование изменений
    └── Оптимизированный UI
        ├── Минимальный GUI
        ├── FPS статистика
        └── Режимы отображения
```

**Характеристики**:
- Разрешение: 512x512 (GPU) / 256x256 (CPU)
- SPP: 16 семплов (адаптивно 4-32)
- Спектральные каналы: R(650nm), G(532nm), B(450nm)
- Real-time: ~15+ FPS
- Дисперсионные эффекты

### 4. `path_integral_engine.py` - Унифицированный движок v3.0 ⭐ **НОВЫЙ**
**Назначение**: Модульная архитектура движка с поддержкой всех предыдущих версий
**Размер**: ~25KB | **Производительность**: Настраиваемая

```python
# Архитектура движка:
├── PathIntegralEngine (главный класс)
│   ├── Конфигурация
│   │   ├── PathIntegralConfig      # Настройки рендеринга
│   │   ├── QualityPreset          # Предустановки качества
│   │   ├── RenderingMode          # Режимы (RGB/Mono)
│   │   └── RenderingBackend       # Backend'ы (MPS/CPU/CUDA)
│   ├── Backend'ы
│   │   ├── GPUMPSBackend          # Apple Silicon оптимизация
│   │   ├── CPUNumpyBackend        # CPU fallback
│   │   └── RenderingBackendInterface # Абстрактный интерфейс
│   ├── Алгоритмы
│   │   ├── _render_spectral()     # Спектральный рендеринг
│   │   ├── _render_monochrome()   # Монохромный рендеринг
│   │   ├── _trace_paths()         # Path integral трассировка
│   │   └── _adjust_quality()      # Адаптивное качество
│   └── Заводские функции
│       ├── create_interactive_engine()
│       ├── create_production_engine()
│       └── create_preview_engine()
```

**Ключевые особенности**:
- **Модульная архитектура** с поддержкой разных backend'ов
- **Предустановки качества**: Preview, Interactive, Production, Research
- **Автоматический fallback** с MPS на CPU
- **Унифицированный API** для всех режимов рендеринга
- **Детальная статистика** и мониторинг производительности
- **Простота расширения** новыми backend'ами и эффектами

## 🏗️ Архитектура движка рендера

### Ядро рендеринга (Rendering Core)
```
PathIntegralEngine
├── SpectralRenderer
│   ├── RGBChannelProcessor    # R(650nm), G(532nm), B(450nm)
│   ├── MonochromeProcessor    # 550nm
│   └── DispersionCalculator   # Материальные эффекты
├── GPUAccelerator (MPS)
│   ├── TensorOperations       # PyTorch MPS оптимизации
│   ├── VectorizedTracing      # Батчевая обработка
│   └── MemoryManager         # Оптимизация памяти GPU
└── AdaptiveQuality
    ├── FPSMonitor            # Мониторинг производительности
    ├── QualityController     # Автоматическое управление SPP
    └── PerformanceOptimizer  # Динамическая оптимизация
```

### Система управления (Control System)
```
InteractionManager
├── CameraController
│   ├── OrbitNavigation       # Орбитальная камера
│   ├── AngleConstraints      # Ограничения поворота
│   └── SmoothTransitions     # Плавные переходы
├── InputHandler
│   ├── MouseRotation         # Управление мышью
│   ├── KeyboardShortcuts     # Горячие клавиши
│   └── EventProcessing       # Обработка событий
└── UIManager
    ├── TerminalInterface     # Консольный интерфейс
    ├── StatusDisplay         # Отображение статуса
    └── ControlsFeedback      # Обратная связь
```

### Физическая симуляция (Physics Simulation)
```
PhysicsEngine
├── PathIntegration
│   ├── QuantumAmplitudes     # Квантовые амплитуды
│   ├── PhaseCalculation      # Фазовые расчеты
│   └── InterferencePatterns  # Интерференционные эффекты
├── OpticalEffects
│   ├── WavelengthDispersion  # Дисперсия по длинам волн
│   ├── MaterialInteraction   # Взаимодействие с материалами
│   └── AttenuationModeling   # Моделирование затухания
└── SceneDefinition
    ├── SDFPrimitives         # SDF примитивы
    ├── GeometryComposition   # Композиция геометрии
    └── MaterialProperties    # Свойства материалов
```

## 🚀 Установка и запуск

### Требования
```bash
# Основные зависимости
pip install torch torchvision numpy pygame opencv-python Pillow

# Для Apple Silicon (рекомендуется)
# PyTorch с MPS поддержкой автоматически
```

### Запуск различных версий

#### 1. Базовая CPU версия (демонстрация)
```bash
python 3_d_path_integral_raymarcher.py
# Время: ~30-60 сек, результат: render_path_integral_raymarcher.png
```

#### 2. GPU Real-time v2.0
```bash
python 3d_path_integral_raymarcher_v2_gpu.py
# Интерактивное окно, монохромный рендеринг
```

#### 3. Продвинутая версия v2.1 (рекомендуется)
```bash
python 3d_path_integral_raymarcher_v2_1_optimized.py
# Полнофункциональный спектральный рендеринг
```

#### 4. Движок v3.0 (для разработчиков)
```python
from path_integral_engine import create_interactive_engine

# Создание движка
engine = create_interactive_engine()

# Рендеринг кадра
img, info = engine.render(scene_sdf, cam_pos, cam_target)
print(f"FPS: {info['fps']:.2f}")
```

## 🎮 Управление

### Универсальные команды
| Действие | Клавиша | Описание |
|----------|---------|----------|
| Вращение камеры | `Mouse` | Орбитальная камера вокруг сцены |
| Сброс камеры | `Space` | Возврат к начальной позиции |
| Выход | `ESC` | Закрытие приложения |

### Продвинутые команды (v2.1+)
| Действие | Клавиша | Описание |
|----------|---------|----------|
| Увеличить качество | `Q` | +4 SPP (до 64) |
| Уменьшить качество | `E` | -4 SPP (до 4) |
| Адаптивное качество | `R` | Вкл/Выкл автоматическое управление |
| Цветной режим | `C` | RGB ↔ Монохромный |

### API движка v3.0
```python
# Создание движков с разными предустановками
preview_engine = create_preview_engine()      # Быстрый предпросмотр
interactive_engine = create_interactive_engine()  # Интерактивный режим  
production_engine = create_production_engine()    # Высокое качество

# Переключение режимов
engine.switch_rendering_mode(RenderingMode.RGB_SPECTRAL)
engine.set_quality_preset(QualityPreset.PRODUCTION)

# Получение информации
info = engine.get_info()
print(f"Backend: {info['backend']}, FPS: {info['stats']['avg_fps']}")
```

## 📊 Производительность

### Сравнение версий
| Версия | Устройство | FPS | SPP | Особенности |
|--------|------------|-----|-----|-------------|
| v1.0 CPU | CPU | 0.02 | 60 | Референсная реализация |
| v2.0 GPU | MPS | 10-15 | 32 | Первая GPU версия |
| v2.1 Opt | MPS | 15+ | 16 | Спектральный + оптимизации |
| v3.0 Engine | MPS | 5-30+ | 4-64 | Модульная архитектура |

### Предустановки качества v3.0
| Preset | Разрешение | SPP | Segments | Target FPS | Применение |
|--------|------------|-----|----------|------------|------------|
| Preview | 256x256 | 4 | 2 | 30 | Быстрый предпросмотр |
| Interactive | 512x512 | 16 | 4 | 15 | Интерактивная работа |
| Production | 1024x1024 | 64 | 8 | 1 | Финальный рендеринг |
| Research | 1024x1024 | 256 | 16 | 0.1 | Научные исследования |

### Рекомендуемые настройки
- **MacBook Air M1/M2**: Interactive preset, RGB режим
- **MacBook Pro M1/M2**: Production preset для статичных кадров
- **Intel Mac/PC**: Preview preset, Monochrome режим
- **Разработка**: Engine v3.0 с кастомными настройками

## 🔬 Научные основы

### Физическая модель
Движок основан на квантово-механическом подходе к распространению света:

1. **Интегралы по путям Фейнмана**: Каждый фотон рассматривается как квантовая амплитуда
2. **Суперпозиция состояний**: Все возможные пути света суммируются
3. **Интерференция**: Фазовые соотношения создают реалистичные паттерны
4. **Дисперсия**: Разные длины волн взаимодействуют по-разному

### Математическая основа
```
Амплитуда = ∑ A(path) × e^(i·k·L(path))
Интенсивность = |Амплитуда|²

где:
- A(path) = амплитуда пути с затуханием
- k = волновое число (2π/λ)  
- L(path) = оптическая длина пути
- λ = длина волны света

Спектральные каналы:
- Красный: λ = 650 нм (k = 9.65 мкм⁻¹)
- Зеленый: λ = 532 нм (k = 11.81 мкм⁻¹)  
- Синий: λ = 450 нм (k = 13.96 мкм⁻¹)
```

### Дисперсионные эффекты
```python
def dispersion_factor(wavelength):
    """Коэффициент дисперсии материала"""
    return 1.0 + 0.3 * (0.55 / wavelength - 1.0)

# Короткие волны (синий) больше рассеиваются
# Длинные волны (красный) меньше рассеиваются
```

## 🛠️ Разработка

### Архитектурные принципы
1. **Модульность**: Четкое разделение рендеринга, физики и интерфейса
2. **Производительность**: GPU-first подход с CPU fallback
3. **Расширяемость**: Легкое добавление новых эффектов и материалов
4. **Интерактивность**: Real-time отзывчивость с адаптивным качеством

### Добавление нового Backend'а
```python
class CustomBackend(RenderingBackendInterface):
    def _setup_device(self):
        return "custom_device"
        
    def render_frame(self, scene_sdf, camera_data):
        # Кастомная логика рендеринга
        pass
        
    def normalize_vector(self, v):
        # Кастомная нормализация
        pass
```

### Создание сложных сцен
```python
def complex_scene_sdf(points):
    """Сложная сцена с множественными объектами"""
    # Сферы
    sphere1 = torch.norm(points - center1, dim=-1) - radius1
    sphere2 = torch.norm(points - center2, dim=-1) - radius2
    
    # CSG операции
    union = torch.minimum(sphere1, sphere2)
    intersection = torch.maximum(sphere1, sphere2)
    difference = torch.maximum(sphere1, -sphere2)
    
    return union
```

## 📈 Roadmap

### v3.1 (В разработке)
- [ ] CUDA backend для NVIDIA GPU
- [ ] Mesh геометрия (OBJ/PLY загрузка)  
- [ ] Материальная система (PBR)
- [ ] Volumetric рендеринг

### v3.2 (Планируется)
- [ ] Neural denoising
- [ ] Temporal accumulation
- [ ] Multi-GPU поддержка
- [ ] Real-time lighting

### v4.0 (Будущее)
- [ ] VR/AR интеграция
- [ ] Cloud рендеринг
- [ ] AI-assisted качество
- [ ] Procedural материалы

## 📚 Ссылки и ресурсы

### Научные статьи
- Feynman, R.P. "Space-time approach to quantum electrodynamics" (1949)
- Kajiya, J. "The rendering equation" (1986)  
- Veach, E. "Robust Monte Carlo methods for light transport simulation" (1997)

### Техническая документация
- [Apple Metal Performance Shaders](https://developer.apple.com/metal/)
- [PyTorch MPS Backend](https://pytorch.org/docs/stable/notes/mps.html)
- [Signed Distance Functions](https://iquilezles.org/articles/distfunctions/)

### Открытый исходный код
Все версии проекта доступны в репозитории с подробными комментариями и примерами использования.

---

*Проект создан для исследования квантово-механических подходов к компьютерной графике и демонстрации возможностей Apple Silicon в научных вычислениях.*
```

**Управление:**
- **Мышь** - Орбитальная камера (сбрасывает накопление)
- **Неподвижность** - Автоматическое накопление качества
- **SPACE** - Пуск/пауза
- **C** - Очистить накопление
- **1/2/3** - Синий/зеленый/красный свет
- **W/S/A/D** - Параметры щелей
- **Q/E** - Качество рендеринга
- **T** - Адаптивное качество вкл/выкл
- **F** - Принудительный фоновый режим
- **ESC** - Выход

### 🔥 Версия 2.3 (Дифракция двойной щели) - `3d_path_integral_raymarcher_v2_3_double_slit.py` ⭐⭐⭐
- **Платформа**: Mac M1/M2 GPU оптимизированная
- **Производительность**: Real-time (512x512 @ 5-12 FPS)
- **Сцена**: Классический эксперимент с дифракцией света
- **Особенности**:
  - Источник света (светящаяся плоскость)
  - Барьер с двумя регулируемыми щелями
  - Экран для наблюдения интерференционных полос
  - Полная симуляция квантовых эффектов
  - Интерактивное изменение параметров эксперимента
- **Использование**: Демонстрация корпускулярно-волнового дуализма

**Запуск:**
```bash
python 3d_path_integral_raymarcher_v2_3_double_slit.py
```

**Управление:**
- **SPACE** - Пуск/пауза симуляции
- **Мышь** - Орбитальная камера вокруг установки
- **G** - Переключить видимость геометрии
- **1/2/3** - Синий/зеленый/красный свет
- **W/S** - Ширина щелей +/-
- **A/D** - Расстояние между щелями +/-
- **Q/E** - Качество +/-
- **R** - Сброс камеры
- **ESC** - Выход

### 3️⃣ Версия 2.2 (macOS Оптимизированная) - `3d_path_integral_raymarcher_v2_2_macos.py` ⭐⭐
- **Платформа**: Mac M1/M2 GPU оптимизированная для macOS
- **Производительность**: Real-time (512x512 @ 5-15 FPS)
- **Качество**: Адаптивное + точная сцена как в оригинале
- **Особенности**: 
  - UI загружается мгновенно, рендеринг на паузе при старте
  - Отдельный поток для рендеринга (не блокирует UI)
  - Идентичная сцена оригинальной версии 1.0
  - Полный контроль через интерфейс
- **Использование**: Лучший выбор для macOS - стабильный UI + качественный рендеринг

**Запуск:**
```bash
python 3d_path_integral_raymarcher_v2_1_optimized.py
```

**Управление:**
- Мышь: Орбитальная камера
- Q/E: Увеличить/уменьшить качество
- R: Переключить адаптивное качество
- Space: Сброс камеры
- ESC: Выход

### 🧪 Сравнение сцен - `quick_scene_comparison.py`
Быстрое создание эталонного изображения для сравнения сцен.

**Запуск:**
```bash
python quick_scene_comparison.py
```

### 4️⃣ Версия 2.1 (Оптимизированная) - `3d_path_integral_raymarcher_v2_1_optimized.py`
- **Платформа**: Mac M1/M2 GPU оптимизированная
- **Производительность**: Real-time (512x512 @ 5-15 FPS)  
- **Качество**: Адаптивное (автоматическое управление)
- **Использование**: Real-time демонстрации с упрощенной сценой

## 🎯 Технологии

### Path Integral Rendering
- **Принцип**: Симуляция всех возможных путей света между камерой и объектами
- **Математика**: Комплексные амплитуды и квантовые интерференции
- **Результат**: Реалистичные оптические эффекты (дифракция, интерференция)

### Apple Silicon Оптимизация
- **MPS (Metal Performance Shaders)**: Нативное GPU ускорение для M1/M2
- **PyTorch**: Векторизованные вычисления на GPU
- **Адаптивное качество**: Автоматическое управление производительностью

### Алгоритмы
- **Sphere Tracing**: Эффективная трассировка лучей с SDF
- **SDF (Signed Distance Fields)**: Математическое описание геометрии
- **Векторизация**: Parallel обработка множества лучей

## 🧪 Эксперимент с двойной щелью

Версия 2.3 симулирует знаменитый эксперимент Юнга с двойной щелью - один из ключевых экспериментов квантовой механики.

### Физика эксперимента:
1. **Источник света** излучает когерентные фотоны
2. **Барьер с двумя щелями** создает два источника вторичных волн
3. **Интерференция** волн от двух щелей создает полосы на экране
4. **Path Integral** симулирует все возможные пути фотонов

### Наблюдаемые эффекты:
- **Интерференционные полосы** - светлые и темные области
- **Зависимость от длины волны** - разные цвета дают разные картины
- **Влияние ширины щелей** - узкие щели = более широкие полосы
- **Влияние расстояния между щелями** - большее расстояние = более узкие полосы

### Параметры для экспериментов:
- Попробуйте разные длины волн (клавиши 1, 2, 3)
- Измените ширину щелей (клавиши W, S)
- Варьируйте расстояние между щелями (клавиши A, D)
- Наблюдайте изменения в реальном времени!

## 📊 Сравнение производительности

| Версия | Разрешение | Время рендера | FPS | Качество | Сцена | Особенности |
|--------|------------|---------------|-----|----------|-------|-------------|
| 1.0    | 220x140    | ~7 минут      | -   | Отличное | Классическая | Эталонная точность |
| 2.0    | 512x512    | Real-time     | 2-5 | Хорошее  | Классическая | GPU ускорение |
| 2.1    | 512x512    | Real-time     | 5-15| Адаптивное| Упрощенная | Оптимизация |
| 2.2    | 512x512    | Real-time     | 5-15| Адаптивное| Классическая | macOS стабильность |
| 2.3    | 512x512    | Real-time     | 5-12| Адаптивное| Дифракция | Квантовые эксперименты |
| **2.5**| **512x512**| **Накопительный**| **0.1-60+**| **Прогрессивное**| **Дифракция** | **Накопление + шумодав** |

## 🔧 Технические детали v2.1

### Ключевые оптимизации:
1. **Адаптивное качество**: SPP автоматически регулируется для поддержания target FPS
2. **Батчированные вычисления**: Оптимальное использование GPU памяти
3. **Переиспользование буферов**: Минимизация аллокаций
4. **Упрощенная трассировка**: Баланс качества и скорости
5. **Орбитальная камера**: Плавное интерактивное управление

### Параметры рендеринга:
- **SPP (Samples Per Pixel)**: 4-64 (адаптивно)
- **Сегменты пути**: 4
- **Максимальные шаги**: 20
- **Длина волны**: 0.55 (зеленый свет)
- **Jitter scale**: 0.3

## 🎨 Сцена

Все версии содержат демонстрационную сцену:
- **3 сферы** различных размеров и позиций
- **Плоскость** (пол)
- **Орбитальная камера** для лучшего обзора

## 💡 Использование

### Для исследований:
Используйте **версию 1.0** для высококачественных изображений.

### Для демонстраций:
Используйте **версию 2.1** для интерактивных real-time демонстраций.

### Для разработки:
Используйте **бенчмарк** для тестирования производительности.

## 🚀 Дальнейшее развитие

Возможные улучшения:
1. **Многопоточность**: CPU + GPU гибридный рендеринг
2. **Материалы**: Различные оптические свойства объектов
3. **Освещение**: Множественные источники света
4. **Post-processing**: Tone mapping, bloom эффекты
5. **VR/AR**: Стереоскопический рендеринг

## 📦 Зависимости

```bash
pip install torch torchvision numpy pygame opencv-python Pillow
```

## 🏆 Результаты

- ✅ CPU версия: Высококачественные изображения
- ✅ GPU версия: Real-time интерактивность
- ✅ MPS оптимизация: Нативное ускорение Apple Silicon
- ✅ Адаптивное качество: Стабильная производительность
- ✅ Path Integral эффекты: Реалистичная оптика

---

**Автор**: 3D Path Integral Raymarcher Project  
**Дата**: Сентябрь 2025  
**Лицензия**: MIT  
